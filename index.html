<!DOCTYPE html>
<html lang="de">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Pfandz√§hlung V2</title>

    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- Icons -->
    <link href="https://unpkg.com/lucide-static/font/lucide.css" rel="stylesheet">

    <style>
        .modal-bg {
            background: rgba(0, 0, 0, 0.6);
        }

        /* Pull-to-Refresh deaktivieren */
        body {
            overscroll-behavior-y: contain;
        }
    </style>
</head>

<body class="min-h-screen bg-gradient-to-br from-gray-900 to-gray-800 pb-20">

    <!-- HEADER -->
    <div class="bg-gray-950 text-white p-4 sticky top-0 z-10 shadow-lg border-b-2 border-blue-500">
        <h1 class="text-2xl font-bold text-center">üì¶ Pfandz√§hlung V2</h1>
        <p class="text-xs text-gray-400 text-center mt-1">Webseite bereitgestellt von Nando</p>

        <div id="datumText" class="mt-2 font-semibold text-center text-blue-400 text-sm"></div>

        <button onclick="resetAll()"
            class="mt-2 w-full bg-red-600 hover:bg-red-700 text-white py-2 px-4 rounded-lg font-semibold">
            Alle zur√ºcksetzen
        </button>
    </div>

    <!-- GRID -->
    <div id="grid" class="p-4 grid grid-cols-2 md:grid-cols-3 gap-4 pb-96"></div>

    <!-- MODAL EDIT -->
    <div id="modal" class="fixed inset-0 modal-bg hidden flex items-center justify-center z-50 p-4">
        <div class="bg-gray-800 rounded-xl p-6 w-full max-w-sm border-2 border-blue-500">
            <h3 id="modalTitle" class="text-lg font-bold text-white mb-4"></h3>
            <input id="modalInput" type="number" inputmode="numeric" pattern="[0-9]*"
                class="w-full p-3 border-2 border-blue-500 bg-gray-700 text-white rounded-lg text-2xl font-bold text-center mb-4">
            <div class="flex gap-2">
                <button onclick="saveEdit()"
                    class="flex-1 bg-green-600 hover:bg-green-700 text-white py-3 rounded-lg font-semibold">‚úì
                    Speichern</button>
                <button onclick="closeModal()"
                    class="flex-1 bg-gray-600 hover:bg-gray-700 text-white py-3 rounded-lg font-semibold">‚úï
                    Abbrechen</button>
            </div>
        </div>
    </div>

    <!-- MODAL ADD -->
    <div id="modalAdd" class="fixed inset-0 modal-bg hidden flex items-center justify-center z-50 p-4">
        <div class="bg-gray-800 rounded-xl p-6 w-full max-w-sm border-2 border-green-500">
            <h3 id="modalAddTitle" class="text-lg font-bold text-white mb-4"></h3>
            <p class="text-gray-300 mb-2">Aktueller Wert: <span id="modalAddCurrent" class="text-blue-400 font-bold"></span></p>
            <input id="modalAddInput" type="number" inputmode="numeric" pattern="[0-9]*" placeholder="Betrag hinzuf√ºgen"
                class="w-full p-3 border-2 border-green-500 bg-gray-700 text-white rounded-lg text-2xl font-bold text-center mb-4">
            <div class="flex gap-2">
                <button onclick="saveAdd()"
                    class="flex-1 bg-green-600 hover:bg-green-700 text-white py-3 rounded-lg font-semibold">‚úì
                    Hinzuf√ºgen</button>
                <button onclick="closeModalAdd()"
                    class="flex-1 bg-gray-600 hover:bg-gray-700 text-white py-3 rounded-lg font-semibold">‚úï
                    Abbrechen</button>
            </div>
        </div>
    </div>

    <!-- MODAL RESET CONFIRMATION -->
    <div id="modalReset" class="fixed inset-0 modal-bg hidden flex items-center justify-center z-50 p-4">
        <div class="bg-gray-800 rounded-xl p-6 w-full max-w-sm border-2 border-red-500">
            <h3 class="text-lg font-bold text-white mb-4">‚ö†Ô∏è Alle Werte zur√ºcksetzen?</h3>
            <p class="text-gray-300 mb-6">Alle gez√§hlten Werte werden auf 0 zur√ºckgesetzt. Diese Aktion kann nicht r√ºckg√§ngig gemacht werden.</p>
            <div class="flex gap-2">
                <button onclick="confirmReset()"
                    class="flex-1 bg-red-600 hover:bg-red-700 text-white py-3 rounded-lg font-semibold">‚úì
                    Zur√ºcksetzen</button>
                <button onclick="closeModalReset()"
                    class="flex-1 bg-gray-600 hover:bg-gray-700 text-white py-3 rounded-lg font-semibold">‚úï
                    Abbrechen</button>
            </div>
        </div>
    </div>

    <!-- ZUSAMMENFASSUNG -->
    <div id="summary"
        class="fixed bottom-0 left-0 right-0 bg-gray-900 border-t-4 border-blue-500 shadow-2xl p-4 max-h-80 overflow-y-auto hidden">
    </div>

    <script>
        /* ---------------------------------------------
           ITEMS: Hybrid (Bild ODER Emoji)
        --------------------------------------------- */

        const items = [
            { name: 'Bier 0,33L', img: 'bier033.png' },
            { name: 'Bier 0,5L', img: 'bier05.png' },
            { name: 'B√ºgel 0,5L (Allg√§uer/Flensburger)', img: 'buegel05.png' },
            { name: 'Stubbi 0,33L (Bundaberg/Astra)', img: 'stubbi03.png' },
            { name: 'B√ºgel 0,33L', img: 'buegel03.png' },
            { name: 'Euro 0,33L (P√ºllecken/Gaffel)', img: 'euro033.png' },
            { name: 'Euro 0,5L (Augustiner/Bayreuther)', img: 'euro05.png' },
            { name: 'Stubbi 0,5L (Veltins)', img: 'stubbi05.png' },
            { name: 'Maurer 0,5L (Kisten)', img: 'maurer05.png' },
            { name: 'Schumacher (Kisten)', img: 'schumacher.png' },
            { name: 'Milch (5 Hoch)', img: 'milch.png' },
            { name: 'Joghurt (10 Hoch)', img: 'joghurt.png' },
            { name: 'Saft 0,7L', img: 'saft07.png' },
            { name: 'Saft 1L', img: 'saft1l.png' },
            { name: 'Wasser 0,7/0,75 Glas', img: 'wasser07glas.png' },
            { name: 'Wasser 1L PET', img: 'wasser1lpet.png' },
            { name: 'GDB 1L', img: 'gdb.png' },
            { name: 'Gerolsteiner 1L PET', img: 'gerolsteiner1lpet.png' },
            { name: 'R√∂merwall 0,7L PET', img: 'roemerwall07.png' },
            { name: 'Mio Mate 0,5L', img: 'miomate.png' },
            { name: 'Gerolsteiner 0,75 Glas', img: 'gerolsteiner07glas.png' },
            { name: 'GDB 0,5L pet', img: 'gdb05pet.png' },
            { name: 'Gerolsteiner 1L Glas', img: 'gerolsteiner1lglas.png' },
            { name: 'Gerolsteiner 0,25 Glas', img: 'gerolsteiner02glas.png' },
            { name: 'Schweppes 0,2L Glas', img: 'schweppes02.png' },
            { name: 'Schweppes 1L PET', img: 'schweppes1l.png' },
            { name: 'Mate 0,5L', img: 'mate05.png' },
            { name: 'Cola PET 1L', img: 'cola1lpet.png' },
            { name: 'Cola Glas 1L', img: 'cola1lglas.png' },
            { name: 'Cola Glas 0,5L', img: 'cola05glas.png' },
            { name: 'Cola Glas 0,2/0,33L', img: 'cola02glas.png' },
            { name: 'Sinalco', img: 'sinalco.png' },
            { name: 'Charitea/Lemonaid', img: 'charitea.png' },

            { name: 'Einweg Glas (Blaue Faltkiste)', img: 'faltbox.png' },
            { name: 'EPS Steigen', emoji: 'üß∫' },

            { name: 'RC', img: 'rc.png' },
            { name: 'IPT', emoji: 'üßä' },
            { name: 'RC Divider', img: 'divider.png' },
            { name: 'Pfands√§cke', emoji: 'üí∞' },
            { name: 'Einwegtalons', emoji: 'üéüÔ∏è' },
            { name: 'Dirty bags', emoji: 'üóëÔ∏è' },
            { name: 'Clean bags', emoji: '‚ú®' },
            { name: 'M√ºlls√§cke', emoji: 'üóëÔ∏è' },
            { name: 'Sodastream', emoji: 'üí®' },
            { name: 'Pfandblomben', img: 'plombe.png' },
            { name: 'Palettenb√§nder', emoji: 'üßµ' },
            { name: 'Papierhandt√ºcher', img: 'papiertuecher.png' },
            { name: 'Folie Klar', img: 'folieklar.png' },
            { name: 'Folie Schwarz', img: 'folieschwarz.png' },
        ];

        // Standardwerte f√ºr bestimmte Items beim Kopieren
        const defaultValues = {
            'Einweg Glas (Blaue Faltkiste)': 'xxxxx',
            'EPS Steigen': 'xxxxx',
            'RC': 'xxxxx',
            'IPT': 'xxxxx',
            'RC Divider': 'xxxxx'
        };

        /* ---------------------------------------------
           RENDER + LOGIC
        --------------------------------------------- */

        let counts = {};
        let editingItem = null;
        let addingItem = null;
        let summaryMinimized = true; // Standardm√§√üig minimiert

        /* -------- LocalStorage Funktionen -------- */
        function saveCounts() {
            const data = {
                counts: counts,
                timestamp: Date.now()
            };
            localStorage.setItem('pfandCounts', JSON.stringify(data));
        }

        function loadCounts() {
            const saved = localStorage.getItem('pfandCounts');
            if (saved) {
                const data = JSON.parse(saved);
                const now = Date.now();
                const sixHours = 6 * 60 * 60 * 1000; // 6 Stunden in Millisekunden

                // Pr√ºfe ob Daten √§lter als 6 Stunden sind
                if (data.timestamp && (now - data.timestamp) < sixHours) {
                    // Daten sind noch g√ºltig
                    counts = data.counts || {};
                } else {
                    // Daten sind zu alt, l√∂sche sie
                    localStorage.removeItem('pfandCounts');
                    counts = {};
                }
            }
        }

        function renderGrid() {
            const grid = document.getElementById("grid");
            grid.innerHTML = "";

            items.forEach(item => {
                const count = counts[item.name] || 0;

                const icon = item.img
                    ? `<img src="img/${item.img}" class="h-20 w-20 object-contain drop-shadow-lg">`
                    : `<div class="text-6xl">${item.emoji}</div>`;

                grid.innerHTML += `
        <div class="bg-gray-800 rounded-xl shadow-md overflow-hidden border border-gray-700">
            <div onclick="increment('${item.name}')" 
                 class="bg-gradient-to-br from-blue-600 to-blue-800 h-32 flex items-center justify-center cursor-pointer active:scale-95">
                ${icon}
            </div>

            <div class="p-3">
                <p class="text-xs font-semibold text-gray-300 leading-tight mb-2">${item.name}</p>
                <div class="flex items-center justify-between gap-2">
                    <span class="text-2xl font-bold text-blue-400">${count}</span>
                    <div class="flex gap-1">
                        <button onclick="startEdit('${item.name}')" class="bg-blue-600 hover:bg-blue-700 text-white w-8 h-8 rounded-full flex items-center justify-center text-xs font-bold">
                            E
                        </button>

                        <button onclick="startAdd('${item.name}')" class="bg-green-600 hover:bg-green-700 text-white w-8 h-8 rounded-full flex items-center justify-center text-lg font-bold">
                            +
                        </button>

                        ${count > 0 ? `
                        <button onclick="decrement('${item.name}')" class="bg-red-600 hover:bg-red-700 text-white w-8 h-8 rounded-full flex items-center justify-center text-lg font-bold">
                            -
                        </button>` : ""}
                    </div>
                </div>
            </div>
        </div>`;
            });

            renderSummary();
        }

        function increment(item) {
            counts[item] = (counts[item] || 0) + 1;
            updateSingleItem(item);
            renderSummary();
            saveCounts();
        }

        function decrement(item) {
            counts[item] = Math.max(0, (counts[item] || 0) - 1);
            updateSingleItem(item);
            renderSummary();
            saveCounts();
        }

        function updateSingleItem(itemName) {
            const item = items.find(i => i.name === itemName);
            const count = counts[itemName] || 0;
            const index = items.indexOf(item);

            const cards = document.querySelectorAll('#grid > div');
            if (cards[index]) {
                const cardContent = cards[index].querySelector('.p-3');
                cardContent.innerHTML = `
            <p class="text-xs font-semibold text-gray-300 leading-tight mb-2">${itemName}</p>
            <div class="flex items-center justify-between gap-2">
                <span class="text-2xl font-bold text-blue-400">${count}</span>
                <div class="flex gap-1">
                    <button onclick="startEdit('${itemName}')" class="bg-blue-600 hover:bg-blue-700 text-white w-8 h-8 rounded-full flex items-center justify-center text-xs font-bold">
                        E
                    </button>

                    <button onclick="startAdd('${itemName}')" class="bg-green-600 hover:bg-green-700 text-white w-8 h-8 rounded-full flex items-center justify-center text-lg font-bold">
                        +
                    </button>

                    ${count > 0 ? `
                    <button onclick="decrement('${itemName}')" class="bg-red-600 hover:bg-red-700 text-white w-8 h-8 rounded-full flex items-center justify-center text-lg font-bold">
                        -
                    </button>` : ""}
                </div>
            </div>
        `;
            }
        }

        /* -------- Modal Edit -------- */
        function startEdit(item) {
            editingItem = item;
            document.getElementById("modal").classList.remove("hidden");
            document.getElementById("modalTitle").innerText = item;
            const input = document.getElementById("modalInput");
            input.value = counts[item] || 0;

            // F√ºr mobile Ger√§te: Tastatur sofort √∂ffnen
            setTimeout(() => {
                input.focus();
                input.select(); // Selektiert den Text f√ºr schnelles √úberschreiben
                // iOS Safari Fix: Trigger input event
                input.setSelectionRange(0, input.value.length);
            }, 150);
        }

        function saveEdit() {
            const value = parseInt(document.getElementById("modalInput").value);
            counts[editingItem] = Math.max(0, value || 0);
            closeModal();
            updateSingleItem(editingItem);
            renderSummary();
            saveCounts();
        }

        function closeModal() {
            document.getElementById("modal").classList.add("hidden");
        }

        /* -------- Modal Add -------- */
        function startAdd(item) {
            addingItem = item;
            document.getElementById("modalAdd").classList.remove("hidden");
            document.getElementById("modalAddTitle").innerText = item;
            document.getElementById("modalAddCurrent").innerText = counts[item] || 0;
            const input = document.getElementById("modalAddInput");
            input.value = "";

            // F√ºr mobile Ger√§te: Tastatur sofort √∂ffnen
            setTimeout(() => {
                input.focus();
                // iOS Safari Fix
                input.click();
            }, 150);
        }

        function saveAdd() {
            const addValue = parseInt(document.getElementById("modalAddInput").value);
            if (!isNaN(addValue)) {
                counts[addingItem] = (counts[addingItem] || 0) + addValue;
            }
            closeModalAdd();
            updateSingleItem(addingItem);
            renderSummary();
            saveCounts();
        }

        function closeModalAdd() {
            document.getElementById("modalAdd").classList.add("hidden");
        }

        /* -------- Reset Confirmation -------- */
        function resetAll() {
            document.getElementById("modalReset").classList.remove("hidden");
        }

        function confirmReset() {
            counts = {};
            localStorage.removeItem('pfandCounts'); // L√∂sche gespeicherte Daten
            closeModalReset();
            renderGrid();
        }

        function closeModalReset() {
            document.getElementById("modalReset").classList.add("hidden");
        }

        /* -------- Summary -------- */
        function toggleSummary() {
            summaryMinimized = !summaryMinimized;
            renderSummary();
        }

        function renderSummary() {
            const summary = document.getElementById("summary");
            const entries = Object.entries(counts).filter(([_, c]) => c > 0);

            if (entries.length === 0) {
                summary.classList.add("hidden");
                return;
            }

            summary.classList.remove("hidden");

            const totalCount = entries.reduce((sum, [_, count]) => sum + count, 0);

            if (summaryMinimized) {
                summary.innerHTML = `
            <div onclick="toggleSummary()" class="flex items-center justify-between cursor-pointer hover:bg-gray-800 p-2 rounded-lg transition">
                <h2 class="text-lg font-bold text-blue-400">üìã ${entries.length} Items (${totalCount} gesamt)</h2>
                <button class="bg-blue-600 text-white px-3 py-1 rounded-lg text-sm">‚ñ≤ √ñffnen</button>
            </div>
        `;
            } else {
                summary.innerHTML = `
            <div class="flex items-center justify-between mb-3">
                <h2 class="text-xl font-bold text-blue-400">üìã Zusammenfassung</h2>
                <div class="flex gap-2">
                    <button onclick="toggleSummary()" class="bg-blue-600 hover:bg-blue-700 text-white px-3 py-2 rounded-lg font-semibold text-sm">
                        ‚ñº Minimieren
                    </button>
                    <button id="copyBtn" onclick="copyToClipboard()" class="transition-all bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-lg font-semibold text-sm">
                        üìã COPY
                    </button>
                </div>
            </div>

            <div class="bg-gray-800 rounded-lg p-3 mb-3 font-mono text-sm border border-gray-700 text-gray-300">
                ${entries.map(([name, count]) => `${name}: ${count}`).join("<br>")}
            </div>

            ${entries.map(([name, count]) => `
                <div class="flex justify-between items-center py-1 border-b border-gray-700">
                    <span class="text-sm font-medium text-gray-300">${name}</span>
                    <span class="text-lg font-bold text-blue-400">${count}</span>
                </div>
            `).join("")}
        `;
            }
        }



        /* -------- Copy Animation -------- */
        function copyToClipboard() {
            const d = new Date();
            const pad = n => n.toString().padStart(2, "0");
            const datum = `${pad(d.getDate())}.${pad(d.getMonth() + 1)}.${d.getFullYear()}`;

            let text = `Pfandz√§hlung vom: ${datum}\n\n`;

            // ALLE Items in der urspr√ºnglichen Reihenfolge
            text += items.map(item => {
                const value = counts[item.name] || 0;
                // Wenn kein Wert gesetzt wurde und es einen Standardwert gibt, diesen verwenden
                const displayValue = (value === 0 && defaultValues[item.name]) ? defaultValues[item.name] : value;
                return `${item.name}: ${displayValue}`;
            }).join("\n");

            navigator.clipboard.writeText(text).then(() => {
                const btn = document.getElementById("copyBtn");
                btn.innerText = "‚úî Kopiert";
                btn.classList.add("bg-green-700", "scale-110");

                setTimeout(() => {
                    btn.innerText = "üìã COPY";
                    btn.classList.remove("bg-green-700", "scale-110");
                }, 1200);
            });
        }

        /* -------- Pull-to-Refresh verhindern -------- */
        let lastTouchY = 0;
        let preventPullToRefresh = false;

        document.addEventListener('touchstart', (e) => {
            if (e.touches.length !== 1) { return; }
            lastTouchY = e.touches[0].clientY;
            // Verhindere Pull-to-Refresh wenn am Seitenanfang
            preventPullToRefresh = (window.pageYOffset === 0);
        }, { passive: false });

        document.addEventListener('touchmove', (e) => {
            const touchY = e.touches[0].clientY;
            const touchYDelta = touchY - lastTouchY;
            lastTouchY = touchY;

            if (preventPullToRefresh) {
                // Verhindere das Scrollen nach oben wenn bereits am Anfang
                if (touchYDelta > 0) {
                    e.preventDefault();
                    return;
                }
            }
        }, { passive: false });

        /* -------- Init -------- */
        window.onload = () => {
            const d = new Date();
            const pad = n => n.toString().padStart(2, "0");
            const heute = `${pad(d.getDate())}.${pad(d.getMonth() + 1)}.${d.getFullYear()}`;
            document.getElementById("datumText").innerText = `Pfandz√§hlung vom: ${heute}`;

            loadCounts(); // Lade gespeicherte Daten
            renderGrid();
        };
    </script>

</body>

</html>